<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Using Parquet Storage for Large Datasets • riemtan</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using Parquet Storage for Large Datasets">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">riemtan</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.5</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/riemtan.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/performance-benchmarks.html">Performance Benchmarking and Optimization</a></li>
    <li><a class="dropdown-item" href="../articles/using-parquet.html">Using Parquet Storage for Large Datasets</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/nicoesve/riemtan/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Using Parquet Storage for Large Datasets</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/nicoesve/riemtan/blob/HEAD/vignettes/using-parquet.Rmd" class="external-link"><code>vignettes/using-parquet.Rmd</code></a></small>
      <div class="d-none name"><code>using-parquet.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>When working with large brain connectome datasets, storing all
matrices in memory as R lists can be inefficient. The
<code>riemtan</code> package now supports Apache Arrow Parquet format
for efficient storage and lazy loading of SPD matrices.</p>
<p>This vignette demonstrates how to:</p>
<ul>
<li>Export connectomes to Parquet format</li>
<li>Load connectomes using the Parquet backend</li>
<li>Work with CSample and CSuperSample using Parquet storage</li>
</ul>
</div>
<div class="section level2">
<h2 id="benefits-of-parquet-storage">Benefits of Parquet Storage<a class="anchor" aria-label="anchor" href="#benefits-of-parquet-storage"></a>
</h2>
<ul>
<li>
<strong>Memory Efficiency</strong>: Matrices are loaded on-demand
rather than all at once</li>
<li>
<strong>Fast Access</strong>: Columnar storage format optimized for
numerical data</li>
<li>
<strong>Metadata Support</strong>: Store subject IDs, provenance,
and other metadata</li>
<li>
<strong>Interoperability</strong>: Standard format compatible with
Python, Julia, and other tools</li>
</ul>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>Make sure you have the <code>arrow</code> package installed:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"arrow"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="basic-workflow">Basic Workflow<a class="anchor" aria-label="anchor" href="#basic-workflow"></a>
</h2>
<div class="section level3">
<h3 id="writing-connectomes-to-parquet">1. Writing Connectomes to Parquet<a class="anchor" aria-label="anchor" href="#writing-connectomes-to-parquet"></a>
</h3>
<p>First, let’s create some example SPD matrices and save them to
Parquet format:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://nicoesve.github.io/riemtan/">riemtan</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://Matrix.R-forge.R-project.org" class="external-link">Matrix</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create example connectomes (4x4 SPD matrices)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">connectomes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">50</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">16</span>, <span class="fl">0</span>, <span class="fl">0.1</span><span class="op">)</span>, <span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span></span>
<span>  <span class="va">mat</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">mat</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span>  <span class="co"># Make symmetric</span></span>
<span>  <span class="va">mat</span> <span class="op">&lt;-</span> <span class="va">mat</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.5</span>  <span class="co"># Ensure positive definite</span></span>
<span>  <span class="fu">Matrix</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/pack-methods.html" class="external-link">pack</a></span><span class="op">(</span><span class="fu">Matrix</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/Matrix.html" class="external-link">Matrix</a></span><span class="op">(</span><span class="va">mat</span>, sparse <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Write to Parquet format</span></span>
<span><span class="fu"><a href="../reference/write_connectomes_to_parquet.html">write_connectomes_to_parquet</a></span><span class="op">(</span></span>
<span>  <span class="va">connectomes</span>,</span>
<span>  output_dir <span class="op">=</span> <span class="st">"my_connectomes"</span>,</span>
<span>  subject_ids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"subject_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">50</span><span class="op">)</span>,</span>
<span>  provenance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    study <span class="op">=</span> <span class="st">"Example Study"</span>,</span>
<span>    acquisition_date <span class="op">=</span> <span class="st">"2024-01-01"</span>,</span>
<span>    preprocessing <span class="op">=</span> <span class="st">"Standard pipeline v1.0"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This creates a directory structure:</p>
<pre><code>my_connectomes/
├── metadata.json
├── matrix_0001.parquet
├── matrix_0002.parquet
├── ...
└── matrix_0050.parquet</code></pre>
</div>
<div class="section level3">
<h3 id="validating-parquet-directory">2. Validating Parquet Directory<a class="anchor" aria-label="anchor" href="#validating-parquet-directory"></a>
</h3>
<p>Before using a Parquet directory, you can validate its structure:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Detailed validation with verbose output</span></span>
<span><span class="fu"><a href="../reference/validate_parquet_directory.html">validate_parquet_directory</a></span><span class="op">(</span><span class="st">"my_connectomes"</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="creating-a-csample-with-parquet-backend">3. Creating a CSample with Parquet Backend<a class="anchor" aria-label="anchor" href="#creating-a-csample-with-parquet-backend"></a>
</h3>
<p>Now use the Parquet backend to create a CSample:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load AIRM metric</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">airm</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create Parquet backend (default cache size: 10 matrices)</span></span>
<span><span class="va">backend</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_parquet_backend.html">create_parquet_backend</a></span><span class="op">(</span></span>
<span>  <span class="st">"my_connectomes"</span>,</span>
<span>  cache_size <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create CSample with the backend</span></span>
<span><span class="va">sample</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/CSample.html">CSample</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  backend <span class="op">=</span> <span class="va">backend</span>,</span>
<span>  metric_obj <span class="op">=</span> <span class="va">airm</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Sample info</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Sample size:"</span>, <span class="va">sample</span><span class="op">$</span><span class="va">sample_size</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Matrix dimension:"</span>, <span class="va">sample</span><span class="op">$</span><span class="va">matrix_size</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="computing-with-parquet-backed-csample">4. Computing with Parquet-backed CSample<a class="anchor" aria-label="anchor" href="#computing-with-parquet-backed-csample"></a>
</h3>
<p>All standard CSample operations work transparently with the Parquet
backend:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute tangent images</span></span>
<span><span class="va">sample</span><span class="op">$</span><span class="fu">compute_tangents</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute vectorized images</span></span>
<span><span class="va">sample</span><span class="op">$</span><span class="fu">compute_vecs</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute Frechet mean</span></span>
<span><span class="va">sample</span><span class="op">$</span><span class="fu">compute_fmean</span><span class="op">(</span>tol <span class="op">=</span> <span class="fl">0.01</span>, max_iter <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Center the sample</span></span>
<span><span class="va">sample</span><span class="op">$</span><span class="fu">center</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute variation</span></span>
<span><span class="va">sample</span><span class="op">$</span><span class="fu">compute_variation</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Variation:"</span>, <span class="va">sample</span><span class="op">$</span><span class="va">variation</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="lazy-loading-behavior">5. Lazy Loading Behavior<a class="anchor" aria-label="anchor" href="#lazy-loading-behavior"></a>
</h3>
<p>The Parquet backend loads matrices on-demand:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Access specific connectome (loads from disk if not cached)</span></span>
<span><span class="va">conn_1</span> <span class="op">&lt;-</span> <span class="va">sample</span><span class="op">$</span><span class="va">connectomes</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Access all connectomes (loads all from disk)</span></span>
<span><span class="va">all_conns</span> <span class="op">&lt;-</span> <span class="va">sample</span><span class="op">$</span><span class="va">connectomes</span></span>
<span></span>
<span><span class="co"># Cache management</span></span>
<span><span class="va">backend</span><span class="op">$</span><span class="fu">get_cache_size</span><span class="op">(</span><span class="op">)</span>  <span class="co"># Check current cache usage</span></span>
<span><span class="va">backend</span><span class="op">$</span><span class="fu">clear_cache</span><span class="op">(</span><span class="op">)</span>     <span class="co"># Clear cache to free memory</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="working-with-csupersample">Working with CSuperSample<a class="anchor" aria-label="anchor" href="#working-with-csupersample"></a>
</h2>
<p>CSuperSample works seamlessly with Parquet-backed samples:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create two samples with different backends</span></span>
<span><span class="va">backend1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_parquet_backend.html">create_parquet_backend</a></span><span class="op">(</span><span class="st">"study1_connectomes"</span><span class="op">)</span></span>
<span><span class="va">backend2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_parquet_backend.html">create_parquet_backend</a></span><span class="op">(</span><span class="st">"study2_connectomes"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sample1</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/CSample.html">CSample</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>backend <span class="op">=</span> <span class="va">backend1</span>, metric_obj <span class="op">=</span> <span class="va">airm</span><span class="op">)</span></span>
<span><span class="va">sample2</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/CSample.html">CSample</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>backend <span class="op">=</span> <span class="va">backend2</span>, metric_obj <span class="op">=</span> <span class="va">airm</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create super sample</span></span>
<span><span class="va">super_sample</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/CSuperSample.html">CSuperSample</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">sample1</span>, <span class="va">sample2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Gather all connectomes</span></span>
<span><span class="va">super_sample</span><span class="op">$</span><span class="fu">gather</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute statistics</span></span>
<span><span class="va">super_sample</span><span class="op">$</span><span class="fu">compute_fmean</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">super_sample</span><span class="op">$</span><span class="fu">compute_variation</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="backwards-compatibility">Backwards Compatibility<a class="anchor" aria-label="anchor" href="#backwards-compatibility"></a>
</h2>
<p>The Parquet backend is fully compatible with the traditional
list-based approach:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Traditional approach (all in memory)</span></span>
<span><span class="va">sample_memory</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/CSample.html">CSample</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  conns <span class="op">=</span> <span class="va">connectomes</span>,</span>
<span>  metric_obj <span class="op">=</span> <span class="va">airm</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Parquet approach (lazy loading)</span></span>
<span><span class="va">backend</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_parquet_backend.html">create_parquet_backend</a></span><span class="op">(</span><span class="st">"my_connectomes"</span><span class="op">)</span></span>
<span><span class="va">sample_parquet</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/CSample.html">CSample</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  backend <span class="op">=</span> <span class="va">backend</span>,</span>
<span>  metric_obj <span class="op">=</span> <span class="va">airm</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Both work identically</span></span>
<span><span class="va">sample_memory</span><span class="op">$</span><span class="fu">compute_fmean</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">sample_parquet</span><span class="op">$</span><span class="fu">compute_fmean</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="performance-tips">Performance Tips<a class="anchor" aria-label="anchor" href="#performance-tips"></a>
</h2>
<div class="section level3">
<h3 id="cache-size-tuning">Cache Size Tuning<a class="anchor" aria-label="anchor" href="#cache-size-tuning"></a>
</h3>
<p>Adjust cache size based on available memory:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Small cache (memory-constrained environments)</span></span>
<span><span class="va">backend_small</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/ParquetBackend.html">ParquetBackend</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"my_connectomes"</span>, cache_size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Large cache (memory-rich environments)</span></span>
<span><span class="va">backend_large</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/ParquetBackend.html">ParquetBackend</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"my_connectomes"</span>, cache_size <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="batch-operations">Batch Operations<a class="anchor" aria-label="anchor" href="#batch-operations"></a>
</h3>
<p>For operations that need all matrices, consider loading in
batches:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Process in chunks</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="va">sample</span><span class="op">$</span><span class="va">sample_size</span></span>
<span><span class="va">batch_size</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">start</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n</span>, by <span class="op">=</span> <span class="va">batch_size</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">end</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">start</span> <span class="op">+</span> <span class="va">batch_size</span> <span class="op">-</span> <span class="fl">1</span>, <span class="va">n</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Load batch</span></span>
<span>  <span class="va">batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">start</span><span class="op">:</span><span class="va">end</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="va">backend</span><span class="op">$</span><span class="fu">get_matrix</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Process batch...</span></span>
<span></span>
<span>  <span class="co"># Clear cache to free memory</span></span>
<span>  <span class="va">backend</span><span class="op">$</span><span class="fu">clear_cache</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="parallel-processing-with-parquet">Parallel Processing with Parquet<a class="anchor" aria-label="anchor" href="#parallel-processing-with-parquet"></a>
</h3>
<p><strong>New in v0.2.5</strong>: riemtan now supports cross-platform
parallel processing that works seamlessly with the Parquet backend.</p>
<div class="section level4">
<h4 id="enabling-parallel-processing">Enabling Parallel Processing<a class="anchor" aria-label="anchor" href="#enabling-parallel-processing"></a>
</h4>
<p>Configure parallel processing using the futureverse framework:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://nicoesve.github.io/riemtan/">riemtan</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Enable parallel processing (works on all platforms including Windows!)</span></span>
<span><span class="fu"><a href="../reference/set_parallel_plan.html">set_parallel_plan</a></span><span class="op">(</span><span class="st">"multisession"</span>, workers <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check status</span></span>
<span><span class="fu"><a href="../reference/is_parallel_enabled.html">is_parallel_enabled</a></span><span class="op">(</span><span class="op">)</span>  <span class="co"># TRUE</span></span>
<span><span class="fu"><a href="../reference/get_n_workers.html">get_n_workers</a></span><span class="op">(</span><span class="op">)</span>        <span class="co"># 4</span></span>
<span></span>
<span><span class="co"># Create Parquet-backed sample</span></span>
<span><span class="va">backend</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_parquet_backend.html">create_parquet_backend</a></span><span class="op">(</span><span class="st">"large_dataset"</span>, cache_size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">sample</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/CSample.html">CSample</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>backend <span class="op">=</span> <span class="va">backend</span>, metric_obj <span class="op">=</span> <span class="va">airm</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="parallel-io-and-computation">Parallel I/O and Computation<a class="anchor" aria-label="anchor" href="#parallel-io-and-computation"></a>
</h4>
<p>All major operations automatically use parallel processing when
beneficial:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Parallel tangent computations with progress bar</span></span>
<span><span class="va">sample</span><span class="op">$</span><span class="fu">compute_tangents</span><span class="op">(</span>progress <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>   <span class="co"># 3-8x faster</span></span>
<span></span>
<span><span class="co"># Parallel vectorization</span></span>
<span><span class="va">sample</span><span class="op">$</span><span class="fu">compute_vecs</span><span class="op">(</span>progress <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>       <span class="co"># 2-4x speedup</span></span>
<span></span>
<span><span class="co"># Parallel Frechet mean computation</span></span>
<span><span class="va">sample</span><span class="op">$</span><span class="fu">compute_fmean</span><span class="op">(</span>progress <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>      <span class="co"># 2-5x faster for large samples</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="batch-loading-with-parallel-io">Batch Loading with Parallel I/O<a class="anchor" aria-label="anchor" href="#batch-loading-with-parallel-io"></a>
</h4>
<p>For very large Parquet datasets, use batch loading with parallel I/O
and memory management:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load specific subset in batches</span></span>
<span><span class="va">subset_conns</span> <span class="op">&lt;-</span> <span class="va">sample</span><span class="op">$</span><span class="fu">load_connectomes_batched</span><span class="op">(</span></span>
<span>  indices <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">500</span>,        <span class="co"># Load first 500 matrices</span></span>
<span>  batch_size <span class="op">=</span> <span class="fl">50</span>,        <span class="co"># 50 matrices per batch</span></span>
<span>  progress <span class="op">=</span> <span class="cn">TRUE</span>         <span class="co"># Show progress</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># This loads 500 matrices in 10 batches, clearing cache between batches</span></span>
<span><span class="co"># Each batch is loaded in parallel for 5-10x speedup</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="performance-comparison">Performance Comparison<a class="anchor" aria-label="anchor" href="#performance-comparison"></a>
</h4>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Sequential (default if not configured)</span></span>
<span><span class="fu"><a href="../reference/set_parallel_plan.html">set_parallel_plan</a></span><span class="op">(</span><span class="st">"sequential"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">sample</span><span class="op">$</span><span class="fu">compute_tangents</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Baseline</span></span>
<span></span>
<span><span class="co"># Parallel with 4 workers</span></span>
<span><span class="fu"><a href="../reference/set_parallel_plan.html">set_parallel_plan</a></span><span class="op">(</span><span class="st">"multisession"</span>, workers <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">sample</span><span class="op">$</span><span class="fu">compute_tangents</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>  <span class="co"># 3-4x faster</span></span>
<span></span>
<span><span class="co"># Parallel with 8 workers</span></span>
<span><span class="fu"><a href="../reference/set_parallel_plan.html">set_parallel_plan</a></span><span class="op">(</span><span class="st">"multisession"</span>, workers <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">sample</span><span class="op">$</span><span class="fu">compute_tangents</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>  <span class="co"># 6-8x faster</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="progress-reporting">Progress Reporting<a class="anchor" aria-label="anchor" href="#progress-reporting"></a>
</h4>
<p>Enable progress bars to monitor long-running operations:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install progressr for progress bars (optional)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"progressr"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Enable parallel processing</span></span>
<span><span class="fu"><a href="../reference/set_parallel_plan.html">set_parallel_plan</a></span><span class="op">(</span><span class="st">"multisession"</span>, workers <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># All operations support progress parameter</span></span>
<span><span class="va">sample</span><span class="op">$</span><span class="fu">compute_tangents</span><span class="op">(</span>progress <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">sample</span><span class="op">$</span><span class="fu">compute_vecs</span><span class="op">(</span>progress <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">sample</span><span class="op">$</span><span class="fu">compute_fmean</span><span class="op">(</span>progress <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Batch loading with progress</span></span>
<span><span class="va">conns</span> <span class="op">&lt;-</span> <span class="va">sample</span><span class="op">$</span><span class="fu">load_connectomes_batched</span><span class="op">(</span></span>
<span>  indices <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span>,</span>
<span>  batch_size <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  progress <span class="op">=</span> <span class="cn">TRUE</span>  <span class="co"># Shows "Batch 1/10: loading matrices 1-100"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="best-practices">Best Practices<a class="anchor" aria-label="anchor" href="#best-practices"></a>
</h4>
<p><strong>1. Choose appropriate worker count</strong>:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Conservative (leave cores for system)</span></span>
<span><span class="fu"><a href="../reference/set_parallel_plan.html">set_parallel_plan</a></span><span class="op">(</span><span class="st">"multisession"</span>, workers <span class="op">=</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Maximum performance (use all cores)</span></span>
<span><span class="fu"><a href="../reference/set_parallel_plan.html">set_parallel_plan</a></span><span class="op">(</span><span class="st">"multisession"</span>, workers <span class="op">=</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>2. Memory management with parallelization</strong>:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Each worker loads its own data copy</span></span>
<span><span class="co"># For 4 workers with 100 matrices of 200x200, expect:</span></span>
<span><span class="co"># Memory = 4 workers × cache_size × matrix_size ≈ 4 × 20 × 320 KB ≈ 25 MB</span></span>
<span></span>
<span><span class="co"># Use smaller cache with more workers</span></span>
<span><span class="va">backend</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_parquet_backend.html">create_parquet_backend</a></span><span class="op">(</span><span class="st">"dataset"</span>, cache_size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/set_parallel_plan.html">set_parallel_plan</a></span><span class="op">(</span><span class="st">"multisession"</span>, workers <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span></code></pre></div>
<p><strong>3. Reset when done</strong>:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute with parallelization</span></span>
<span><span class="fu"><a href="../reference/set_parallel_plan.html">set_parallel_plan</a></span><span class="op">(</span><span class="st">"multisession"</span>, workers <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">sample</span><span class="op">$</span><span class="fu">compute_tangents</span><span class="op">(</span>progress <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">sample</span><span class="op">$</span><span class="fu">compute_fmean</span><span class="op">(</span>progress <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Reset to free worker resources</span></span>
<span><span class="fu"><a href="../reference/reset_parallel_plan.html">reset_parallel_plan</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="auto-detection">Auto-Detection<a class="anchor" aria-label="anchor" href="#auto-detection"></a>
</h4>
<p>Parallel processing is <strong>automatically disabled</strong> for
small datasets to avoid overhead:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Small dataset (n &lt; 10): Uses sequential processing automatically</span></span>
<span><span class="va">small_sample</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/CSample.html">CSample</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>conns <span class="op">=</span> <span class="va">small_connectomes</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>, metric_obj <span class="op">=</span> <span class="va">airm</span><span class="op">)</span></span>
<span><span class="va">small_sample</span><span class="op">$</span><span class="fu">compute_tangents</span><span class="op">(</span><span class="op">)</span>  <span class="co"># Sequential (no overhead)</span></span>
<span></span>
<span><span class="co"># Large dataset (n &gt;= 10): Uses parallel processing automatically</span></span>
<span><span class="va">large_sample</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/CSample.html">CSample</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>backend <span class="op">=</span> <span class="va">backend</span>, metric_obj <span class="op">=</span> <span class="va">airm</span><span class="op">)</span></span>
<span><span class="va">large_sample</span><span class="op">$</span><span class="fu">compute_tangents</span><span class="op">(</span><span class="op">)</span>  <span class="co"># Parallel (if plan is active)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="parallel-strategies">Parallel Strategies<a class="anchor" aria-label="anchor" href="#parallel-strategies"></a>
</h4>
<p>Different strategies for different environments:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># multisession: Works on all platforms (Windows, Mac, Linux)</span></span>
<span><span class="fu"><a href="../reference/set_parallel_plan.html">set_parallel_plan</a></span><span class="op">(</span><span class="st">"multisession"</span>, workers <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># multicore: Unix only, lower overhead</span></span>
<span><span class="fu"><a href="../reference/set_parallel_plan.html">set_parallel_plan</a></span><span class="op">(</span><span class="st">"multicore"</span>, workers <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>  <span class="co"># Auto-fallback to multisession on Windows</span></span>
<span></span>
<span><span class="co"># cluster: For remote/distributed computing</span></span>
<span><span class="fu"><a href="../reference/set_parallel_plan.html">set_parallel_plan</a></span><span class="op">(</span><span class="st">"cluster"</span>, workers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"node1"</span>, <span class="st">"node2"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="metadata-access">Metadata Access<a class="anchor" aria-label="anchor" href="#metadata-access"></a>
</h2>
<p>Access metadata stored with your Parquet data:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get metadata</span></span>
<span><span class="va">metadata</span> <span class="op">&lt;-</span> <span class="va">backend</span><span class="op">$</span><span class="fu">get_metadata</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Access subject IDs</span></span>
<span><span class="va">subject_ids</span> <span class="op">&lt;-</span> <span class="va">metadata</span><span class="op">$</span><span class="va">subject_ids</span></span>
<span></span>
<span><span class="co"># Access provenance information</span></span>
<span><span class="va">provenance</span> <span class="op">&lt;-</span> <span class="va">metadata</span><span class="op">$</span><span class="va">provenance</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">provenance</span><span class="op">$</span><span class="va">study</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">provenance</span><span class="op">$</span><span class="va">preprocessing</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="advanced-custom-file-patterns">Advanced: Custom File Patterns<a class="anchor" aria-label="anchor" href="#advanced-custom-file-patterns"></a>
</h2>
<p>Customize the Parquet file naming pattern:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/write_connectomes_to_parquet.html">write_connectomes_to_parquet</a></span><span class="op">(</span></span>
<span>  <span class="va">connectomes</span>,</span>
<span>  output_dir <span class="op">=</span> <span class="st">"custom_naming"</span>,</span>
<span>  file_pattern <span class="op">=</span> <span class="st">"conn_%03d.parquet"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Files will be named: conn_001.parquet, conn_002.parquet, ...</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="troubleshooting">Troubleshooting<a class="anchor" aria-label="anchor" href="#troubleshooting"></a>
</h2>
<div class="section level3">
<h3 id="large-datasets">Large Datasets<a class="anchor" aria-label="anchor" href="#large-datasets"></a>
</h3>
<p>For very large datasets (1000+ matrices):</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Use minimal cache</span></span>
<span><span class="va">backend</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/ParquetBackend.html">ParquetBackend</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"large_dataset"</span>, cache_size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute statistics without loading all matrices at once</span></span>
<span><span class="va">sample</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/CSample.html">CSample</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>backend <span class="op">=</span> <span class="va">backend</span>, metric_obj <span class="op">=</span> <span class="va">airm</span><span class="op">)</span></span>
<span><span class="va">sample</span><span class="op">$</span><span class="fu">compute_tangents</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">sample</span><span class="op">$</span><span class="fu">compute_vecs</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Operations that don't need all matrices in memory</span></span>
<span><span class="va">sample</span><span class="op">$</span><span class="fu">compute_fmean</span><span class="op">(</span>batch_size <span class="op">=</span> <span class="fl">32</span><span class="op">)</span>  <span class="co"># Uses batching</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="memory-monitoring">Memory Monitoring<a class="anchor" aria-label="anchor" href="#memory-monitoring"></a>
</h3>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check cache usage</span></span>
<span><span class="va">cache_size</span> <span class="op">&lt;-</span> <span class="va">backend</span><span class="op">$</span><span class="fu">get_cache_size</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Cached matrices:"</span>, <span class="va">cache_size</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Free memory when needed</span></span>
<span><span class="va">backend</span><span class="op">$</span><span class="fu">clear_cache</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>The Parquet backend provides:</p>
<ul>
<li>
<strong>Scalability</strong>: Handle datasets too large for
memory</li>
<li>
<strong>Efficiency</strong>: Lazy loading minimizes memory
footprint</li>
<li>
<strong>Flexibility</strong>: Fully compatible with existing riemtan
workflows</li>
<li>
<strong>Metadata</strong>: Rich metadata support for reproducible
research</li>
</ul>
<p>For small to medium datasets that fit in memory, the traditional list
approach remains perfectly valid. For large brain connectome studies,
the Parquet backend enables analysis at scale.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Nicolas Escobar.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
